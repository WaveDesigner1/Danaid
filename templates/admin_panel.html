<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Danaid Chat</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body class="admin-app">
    <header class="admin-header">
        <div class="admin-logo">
            <i class="fa fa-shield"></i> Admin Panel
        </div>
        <nav class="admin-nav">
            <a href="/admin_dashboard"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="/flask_admin/" target="_blank"><i class="fa fa-cogs"></i> Pe≈Çny Panel</a>
            <a href="/chat"><i class="fa fa-comments"></i> Czat</a>
            <a href="/logout"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-main">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active">
                        <a href="/admin_dashboard">
                            <i class="fa fa-dashboard"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/diagnostics/" target="_blank">
                            <i class="fa fa-stethoscope"></i> Diagnostyka
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/webshell/" target="_blank">
                            <i class="fa fa-terminal"></i> Webshell
                        </a>
                    </li>
                    <li>
                        <a href="/api/admin/debug" target="_blank">
                            <i class="fa fa-bug"></i> Debug API
                        </a>
                    </li>
                    <li>
                        <a href="/db-debug" target="_blank">
                            <i class="fa fa-database"></i> DB Debug
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard Administratora</h3>
                    <div>
                        <button id="refresh-stats" class="btn btn-secondary btn-sm">
                            <i class="fa fa-refresh"></i> Od≈õwie≈º
                        </button>
                        <button id="debug-btn" class="btn btn-warning btn-sm">
                            <i class="fa fa-bug"></i> Debug
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ERROR HANDLING -->
                    <div id="error-container" style="display: none;">
                        <div class="error-message">
                            <h4><i class="fa fa-exclamation-triangle"></i> B≈ÇƒÖd</h4>
                            <p id="error-message"></p>
                            <button id="retry-btn" class="btn btn-primary btn-sm">
                                <i class="fa fa-retry"></i> Spr√≥buj ponownie
                            </button>
                        </div>
                    </div>
                    
                    <!-- LOADING STATE -->
                    <div id="loading-container" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #ff9800;"></i>
                        <p style="margin-top: 20px;">≈Åadowanie danych...</p>
                    </div>
                    
                    <!-- MAIN STATS GRID -->
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="stat-value" id="users-count">-</div>
                            <div class="stat-label">U≈ºytkownicy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="stat-value" id="sessions-count">-</div>
                            <div class="stat-label">Sesje Czatu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="stat-value" id="messages-count">-</div>
                            <div class="stat-label">Wiadomo≈õci</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="stat-value" id="online-count">-</div>
                            <div class="stat-label">Online</div>
                        </div>
                    </div>
                    
                    <!-- SYSTEM INFO -->
                    <div style="margin-top: 30px;">
                        <h4><i class="fa fa-info-circle"></i> Informacje systemowe</h4>
                        <div id="system-info" style="background: #2d2d2d; padding: 15px; border-radius: 4px; margin-top: 10px;">
                            <p id="last-update">Ostatnia aktualizacja: -</p>
                            <p id="admin-user">Administrator: Loading...</p>
                            <p id="template-loaded">Template: admin_panel.html ‚úÖ</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- NOTIFICATIONS CONTAINER -->
    <div id="notifications-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // NAPRAWIONY ADMIN PANEL JAVASCRIPT
        let isLoading = false;
        
        function showLoading() {
            isLoading = true;
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('stats-grid').classList.add('loading');
            document.getElementById('error-container').style.display = 'none';
        }
        
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('stats-grid').classList.remove('loading');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('stats-grid').style.display = 'none';
            hideLoading();
        }
        
        function hideError() {
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('stats-grid').style.display = 'grid';
        }
        
        // NAPRAWIONE ≈ÅADOWANIE STATYSTYK
        function loadStats() {
            if (isLoading) {
                console.log('Already loading stats, skipping...');
                return;
            }
            
            showLoading();
            hideError();
            
            console.log('üîÑ Loading admin stats...');
            
            fetch('/api/admin/stats?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log(`üì° Response status: ${response.status}`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Brak uprawnie≈Ñ administratora');
                    } else if (response.status === 500) {
                        throw new Error('B≈ÇƒÖd serwera - sprawd≈∫ logi');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                return response.json();
            })
            .then(result => {
                console.log("‚úÖ Stats loaded:", result);
                
                if (result.status === 'error') {
                    throw new Error(result.message || 'B≈ÇƒÖd API');
                }
                
                if (result.status === 'success' && result.data) {
                    const stats = result.data;
                    
                    // Update stats with fallbacks
                    document.getElementById('users-count').textContent = stats.users_count || 0;
                    document.getElementById('sessions-count').textContent = stats.sessions_count || 0;
                    document.getElementById('messages-count').textContent = stats.messages_count || 0;
                    document.getElementById('online-count').textContent = stats.online_users_count || 0;
                    
                    // Update system info
                    document.getElementById('last-update').textContent = 
                        'Ostatnia aktualizacja: ' + new Date().toLocaleString();
                    
                    showNotification('Statystyki zaktualizowane', 'success', 2000);
                } else {
                    throw new Error('Nieprawid≈Çowy format danych');
                }
                
                hideLoading();
            })
            .catch(error => {
                console.error('‚ùå Stats loading error:', error);
                showError(`B≈ÇƒÖd ≈Çadowania statystyk: ${error.message}`);
                showNotification(`B≈ÇƒÖd: ${error.message}`, 'error');
            });
        }
        
        // ADMIN USER INFO
        function loadAdminInfo() {
            fetch('/api/check_admin?' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                if (data.username) {
                    document.getElementById('admin-user').textContent = 
                        `Administrator: ${data.username} (ID: ${data.user_id || 'N/A'})`;
                } else {
                    document.getElementById('admin-user').textContent = 
                        'Administrator: B≈ÇƒÖd pobierania danych';
                }
            })
            .catch(error => {
                console.error('‚ùå Admin info error:', error);
                document.getElementById('admin-user').textContent = 
                    'Administrator: B≈ÇƒÖd pobierania danych';
            });
        }
        
        // DEBUG FUNCTION
        function runDebug() {
            console.log('üêõ Running admin debug...');
            
            Promise.all([
                fetch('/api/admin/debug').then(r => r.json()).catch(e => ({error: e.message})),
                fetch('/api/check_admin').then(r => r.json()).catch(e => ({error: e.message})),
                fetch('/check_session').then(r => r.json()).catch(e => ({error: e.message}))
            ])
            .then(([debug, admin, session]) => {
                console.log('üîç Debug Results:');
                console.log('  Admin Debug:', debug);
                console.log('  Admin Check:', admin);
                console.log('  Session Check:', session);
                
                showNotification('Debug info logged to console', 'info');
            })
            .catch(error => {
                console.error('‚ùå Debug error:', error);
                showNotification('Debug failed: ' + error.message, 'error');
            });
        }
        
        // NOTIFICATIONS
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: inherit; margin-left: 10px; cursor: pointer; font-size: 18px;">√ó</button>
                </div>
            `;
            
            const container = document.getElementById('notifications-container');
            container.appendChild(notification);
            
            // Auto remove
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
        
        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin panel initialized (FIXED VERSION)');
            
            // Load initial data with error handling
            try {
                loadStats();
                loadAdminInfo();
            } catch (error) {
                console.error('‚ùå Initial load error:', error);
                showError('B≈ÇƒÖd inicjalizacji panelu');
            }
            
            // Button event listeners with null checks
            const refreshBtn = document.getElementById('refresh-stats');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log('üîÑ Manual refresh triggered');
                    loadStats();
                });
            }
            
            const debugBtn = document.getElementById('debug-btn');
            if (debugBtn) {
                debugBtn.addEventListener('click', runDebug);
            }
            
            const retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    console.log('üîÑ Retry triggered');
                    loadStats();
                });
            }
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (!isLoading) {
                    console.log('‚è∞ Auto-refresh triggered');
                    loadStats();
                }
            }, 30000);
            
            console.log('‚úÖ Admin panel ready (FIXED VERSION)');
        });
        
        // GLOBAL ERROR HANDLER
        window.addEventListener('error', function(e) {
            console.error('üí• Global error:', e.error);
            showNotification('WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd', 'error');
        });
        
        // GLOBAL FUNCTIONS
        window.adminDebug = {
            loadStats: loadStats,
            loadAdminInfo: loadAdminInfo, 
            runDebug: runDebug,
            showNotification: showNotification
        };
        
        console.log('‚úÖ Admin panel JavaScript loaded (FIXED VERSION)');
    </script>
</body>
</html>
