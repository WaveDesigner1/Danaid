<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_panel.css') }}">
</head>
<body class="admin-panel">
    <header class="admin-header">
        <div class="admin-logo">Admin Panel</div>
        <nav class="admin-nav">
            <a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="{{ url_for('admin.index') }}"><i class="fa fa-cogs"></i> Pełny Panel</a>
            <a href="{{ url_for('auth.logout') }}"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active"><a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
                    <li><a href="{{ url_for('user.index_view') }}"><i class="fa fa-users"></i> Użytkownicy</a></li>
                    <li><a href="{{ url_for('chatsession.index_view') }}"><i class="fa fa-comments"></i> Sesje Czatu</a></li>
                    <li><a href="{{ url_for('message.index_view') }}"><i class="fa fa-envelope"></i> Wiadomości</a></li>
                    <li><a href="{{ url_for('db_admin.index') }}"><i class="fa fa-database"></i> Zarządzanie Bazą</a></li>
                    <li><a href="{{ url_for('diagnostics.index') }}"><i class="fa fa-stethoscope"></i> Diagnostyka</a></li>
                    <li><a href="{{ url_for('webshell.index') }}"><i class="fa fa-terminal"></i> Webshell</a></li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard</h3>
                    <button id="refresh-stats" class="admin-btn secondary">
                        <i class="fa fa-refresh"></i> Odśwież statystyki
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="admin-stats-container">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="admin-stat-value" id="users-count">-</div>
                            <div class="admin-stat-label">Użytkownicy</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="admin-stat-value" id="sessions-count">-</div>
                            <div class="admin-stat-label">Sesje Czatu</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="admin-stat-value" id="messages-count">-</div>
                            <div class="admin-stat-label">Wiadomości</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="admin-stat-value" id="online-count">-</div>
                            <div class="admin-stat-label">Użytkownicy Online</div>
                        </div>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3><i class="fa fa-users"></i> Zarządzanie Użytkownikami</h3>
                            <div class="admin-btn-group">
                                <button id="repair-all-admins" class="admin-btn primary mr-2">
                                    <i class="fa fa-wrench"></i> Napraw uprawnienia
                                </button>
                                <button id="refresh-users" class="admin-btn secondary">
                                    <i class="fa fa-refresh"></i> Odśwież
                                </button>
                            </div>
                        </div>
                        <div class="admin-card-body">
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nazwa</th>
                                            <th>ID Użytkownika</th>
                                            <th>Status</th>
                                            <th>Rola</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center">Ładowanie użytkowników...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Kontener powiadomień (będzie wypełniony dynamicznie) -->
    <div id="notifications-container"></div>

    <!-- Modal diagnostyczny dla danych użytkownika -->
    <div class="modal fade" id="userDataModal" tabindex="-1" role="dialog" aria-labelledby="userDataModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="userDataModalLabel">Diagnostyka danych użytkownika</h4>
                </div>
                <div class="modal-body">
                    <div id="user-data-details" style="background-color: #333; color: #fff; padding: 15px; border-radius: 4px; overflow-x: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button id="fix-user-admin" class="admin-btn primary" data-user-id="">Napraw uprawnienia</button>
                    <button type="button" class="admin-btn secondary" data-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/admin_users.js') }}"></script>
    <script>
        // Funkcja do ładowania statystyk
        function loadStats() {
            // Pobierz wszystkie statystyki za jednym razem
            fetch('/api/admin/stats?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Status: ' + response.status);
                }
                return response.json();
            })
            .then(result => {
                console.log("Pobrane statystyki:", result);
                
                // Sprawdź format odpowiedzi
                if (result.status === 'error') {
                    console.error('API error:', result.message);
                    document.getElementById('users-count').textContent = '-';
                    document.getElementById('sessions-count').textContent = '-';
                    document.getElementById('messages-count').textContent = '-';
                    document.getElementById('online-count').textContent = '-';
                    showNotification('Błąd podczas pobierania statystyk: ' + result.message, 'error');
                    return;
                }
                
                if (result.status === 'success' && result.data) {
                    // Aktualizuj wszystkie liczniki
                    const stats = result.data;
                    document.getElementById('users-count').textContent = stats.users_count;
                    document.getElementById('sessions-count').textContent = stats.sessions_count;
                    document.getElementById('messages-count').textContent = stats.messages_count;
                    document.getElementById('online-count').textContent = stats.online_users_count;
                } else {
                    console.error('Nieprawidłowy format danych:', result);
                    document.getElementById('users-count').textContent = '-';
                    document.getElementById('sessions-count').textContent = '-';
                    document.getElementById('messages-count').textContent = '-';
                    document.getElementById('online-count').textContent = '-';
                    showNotification('Błąd: Nieprawidłowy format danych statystyk', 'error');
                }
            })
            .catch(error => {
                console.error('Błąd podczas pobierania statystyk:', error);
                document.getElementById('users-count').textContent = '-';
                document.getElementById('sessions-count').textContent = '-';
                document.getElementById('messages-count').textContent = '-';
                document.getElementById('online-count').textContent = '-';
                showNotification('Błąd podczas pobierania statystyk: ' + error.message, 'error');
            });
        }
        
        // Ładowanie statystyk przy załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // Obsługa kliknięcia przycisku odświeżenia statystyk
            const refreshStatsButton = document.getElementById('refresh-stats');
            if (refreshStatsButton) {
                refreshStatsButton.addEventListener('click', function() {
                    loadStats();
                    showNotification('Odświeżanie statystyk...', 'info');
                });
            }
            
            // Obsługa przycisku naprawy wszystkich uprawnień
            const repairAllAdminsButton = document.getElementById('repair-all-admins');
            if (repairAllAdminsButton) {
                repairAllAdminsButton.addEventListener('click', function() {
                    if (confirm('Czy na pewno chcesz naprawić uprawnienia wszystkich administratorów?')) {
                        window.location.href = '/admin/repair_all_admin_permissions';
                    }
                });
            }
            
            // Odświeżanie statystyk co 30 sekund
            setInterval(loadStats, 30000);
        });
    </script>
</body>
</html>
