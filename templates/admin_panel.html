<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_panel.css') }}">
</head>
<body class="admin-panel">
    <header class="admin-header">
        <div class="admin-logo">Admin Panel</div>
        <nav class="admin-nav">
            <a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="{{ url_for('admin.index') }}"><i class="fa fa-cogs"></i> Pełny Panel</a>
            <a href="{{ url_for('auth.logout') }}"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active"><a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
                    <li><a href="{{ url_for('user.index_view') }}"><i class="fa fa-users"></i> Użytkownicy</a></li>
                    <li><a href="{{ url_for('chatsession.index_view') }}"><i class="fa fa-comments"></i> Sesje Czatu</a></li>
                    <li><a href="{{ url_for('message.index_view') }}"><i class="fa fa-envelope"></i> Wiadomości</a></li>
                    <li><a href="{{ url_for('db_admin.index') }}"><i class="fa fa-database"></i> Zarządzanie Bazą</a></li>
                    <li><a href="{{ url_for('diagnostics.index') }}"><i class="fa fa-stethoscope"></i> Diagnostyka</a></li>
                    <li><a href="{{ url_for('webshell.index') }}"><i class="fa fa-terminal"></i> Webshell</a></li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard</h3>
                    <button id="refresh-stats" class="admin-btn secondary">
                        <i class="fa fa-refresh"></i> Odśwież statystyki
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="admin-stats-container">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="admin-stat-value" id="users-count">-</div>
                            <div class="admin-stat-label">Użytkownicy</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="admin-stat-value" id="sessions-count">-</div>
                            <div class="admin-stat-label">Sesje Czatu</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="admin-stat-value" id="messages-count">-</div>
                            <div class="admin-stat-label">Wiadomości</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="admin-stat-value" id="online-count">-</div>
                            <div class="admin-stat-label">Użytkownicy Online</div>
                        </div>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3><i class="fa fa-users"></i> Zarządzanie Użytkownikami</h3>
                            <div class="admin-btn-group">
                                <button id="refresh-users" class="admin-btn secondary">
                                    <i class="fa fa-refresh"></i> Odśwież
                                </button>
                            </div>
                        </div>
                        <div class="admin-card-body">
                            <div class="alert alert-info">
                                <p><i class="fa fa-info-circle"></i> <strong>Uwaga:</strong> Zarządzanie uprawnieniami jest możliwe bezpośrednio w bazie danych Railway.</p>
                            </div>
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nazwa</th>
                                            <th>ID Użytkownika</th>
                                            <th>Status</th>
                                            <th>Rola</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center">Ładowanie użytkowników...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Kontener powiadomień (będzie wypełniony dynamicznie) -->
    <div id="notifications-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/admin_users.js') }}"></script>
    <script>
        // Funkcja do ładowania statystyk
        function loadStats() {
            // Pobierz wszystkie statystyki za jednym razem
            fetch('/api/admin/stats?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Status: ' + response.status);
                }
                return response.json();
            })
            .then(result => {
                console.log("Pobrane statystyki:", result);
                
                // Sprawdź format odpowiedzi
                if (result.status === 'error') {
                    console.error('API error:', result.message);
                    document.getElementById('users-count').textContent = '-';
                    document.getElementById('sessions-count').textContent = '-';
                    document.getElementById('messages-count').textContent = '-';
                    document.getElementById('online-count').textContent = '-';
                    showNotification('Błąd podczas pobierania statystyk: ' + result.message, 'error');
                    return;
                }
                
                if (result.status === 'success' && result.data) {
                    // Aktualizuj wszystkie liczniki
                    const stats = result.data;
                    document.getElementById('users-count').textContent = stats.users_count;
                    document.getElementById('sessions-count').textContent = stats.sessions_count;
                    document.getElementById('messages-count').textContent = stats.messages_count;
                    document.getElementById('online-count').textContent = stats.online_users_count;
                } else {
                    console.error('Nieprawidłowy format danych:', result);
                    document.getElementById('users-count').textContent = '-';
                    document.getElementById('sessions-count').textContent = '-';
                    document.getElementById('messages-count').textContent = '-';
                    document.getElementById('online-count').textContent = '-';
                    showNotification('Błąd: Nieprawidłowy format danych statystyk', 'error');
                }
            })
            .catch(error => {
                console.error('Błąd podczas pobierania statystyk:', error);
                document.getElementById('users-count').textContent = '-';
                document.getElementById('sessions-count').textContent = '-';
                document.getElementById('messages-count').textContent = '-';
                document.getElementById('online-count').textContent = '-';
                showNotification('Błąd podczas pobierania statystyk: ' + error.message, 'error');
            });
        }
        
        // Funkcja do wyświetlania powiadomień
        function showNotification(message, type = 'info') {
            // Mapowanie typów na klasy
            const typeClass = {
                'success': 'success',
                'error': 'danger',
                'info': 'info',
                'warning': 'warning'
            };
            
            // Wybór ikony
            const iconClass = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'info': 'info-circle',
                'warning': 'exclamation-triangle'
            };
            
            // Domyślny typ, jeśli podany jest nieprawidłowy
            const alertClass = typeClass[type] || 'info';
            const icon = iconClass[type] || 'info-circle';
            
            // Sprawdź, czy kontener powiadomień istnieje
            let notificationsContainer = document.getElementById('notifications-container');
            
            if (!notificationsContainer) {
                // Utwórz kontener, jeśli nie istnieje
                notificationsContainer = document.createElement('div');
                notificationsContainer.id = 'notifications-container';
                notificationsContainer.style.position = 'fixed';
                notificationsContainer.style.top = '20px';
                notificationsContainer.style.right = '20px';
                notificationsContainer.style.zIndex = '9999';
                document.body.appendChild(notificationsContainer);
            }
            
            // Utwórz powiadomienie
            const notification = document.createElement('div');
            notification.className = `admin-card`;
            notification.style.minWidth = '300px';
            notification.style.marginBottom = '10px';
            notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            notification.style.backgroundColor = 'var(--admin-bg-medium)';
            notification.style.padding = '15px';
            notification.style.borderLeft = `4px solid var(--admin-${alertClass})`;
            notification.innerHTML = `
                <button type="button" class="close" style="color: var(--admin-text);">&times;</button>
                <div>
                    <i class="fa fa-${icon}" style="color: var(--admin-${alertClass}); margin-right: 8px;"></i>
                    ${message}
                </div>
            `;
            
            // Dodaj powiadomienie do kontenera
            notificationsContainer.appendChild(notification);
            
            // Automatycznie zamknij po 5 sekundach
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (notification.parentNode === notificationsContainer) {
                        notificationsContainer.removeChild(notification);
                    }
                }, 500);
            }, 5000);
            
            // Obsługa przycisku zamknięcia
            const closeButton = notification.querySelector('.close');
            closeButton.addEventListener('click', function() {
                notification.remove();
            });
        }

        // Ładowanie statystyk przy załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // Obsługa kliknięcia przycisku odświeżenia statystyk
            const refreshStatsButton = document.getElementById('refresh-stats');
            if (refreshStatsButton) {
                refreshStatsButton.addEventListener('click', function() {
                    loadStats();
                    showNotification('Odświeżanie statystyk...', 'info');
                });
            }
            
            // Odświeżanie statystyk co 30 sekund
            setInterval(loadStats, 30000);
        });
    </script>
</body>
</html>
