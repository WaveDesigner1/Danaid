<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Danaid Chat</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body class="admin-app">
    <header class="admin-header">
        <div class="admin-logo">
            <i class="fa fa-shield"></i> Admin Panel
        </div>
        <nav class="admin-nav">
            <a href="/admin_dashboard"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="/flask_admin/" target="_blank"><i class="fa fa-cogs"></i> Pełny Panel</a>
            <a href="/chat"><i class="fa fa-comments"></i> Czat</a>
            <a href="/logout"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-main">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active">
                        <a href="/admin_dashboard">
                            <i class="fa fa-dashboard"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/diagnostics/" target="_blank">
                            <i class="fa fa-stethoscope"></i> Diagnostyka
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/webshell/" target="_blank">
                            <i class="fa fa-terminal"></i> Webshell
                        </a>
                    </li>
                    <li>
                        <a href="/api/admin/debug" target="_blank">
                            <i class="fa fa-bug"></i> Debug API
                        </a>
                    </li>
                    <li>
                        <a href="/db-debug" target="_blank">
                            <i class="fa fa-database"></i> DB Debug
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard Administratora</h3>
                    <div>
                        <button id="refresh-stats" class="btn btn-secondary btn-sm">
                            <i class="fa fa-refresh"></i> Odśwież
                        </button>
                        <button id="debug-btn" class="btn btn-warning btn-sm">
                            <i class="fa fa-bug"></i> Debug
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Obsługa błędów -->
                    <div id="error-container" style="display: none;">
                        <div class="error-message">
                            <h4><i class="fa fa-exclamation-triangle"></i> Błąd</h4>
                            <p id="error-message"></p>
                            <button id="retry-btn" class="btn btn-primary btn-sm">
                                <i class="fa fa-retry"></i> Spróbuj ponownie
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stan ładowania -->
                    <div id="loading-container" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #ff9800;"></i>
                        <p style="margin-top: 20px;">Ładowanie danych...</p>
                    </div>
                    
                    <!-- Siatka statystyk -->
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="stat-value" id="users-count">-</div>
                            <div class="stat-label">Użytkownicy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="stat-value" id="sessions-count">-</div>
                            <div class="stat-label">Sesje Czatu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="stat-value" id="messages-count">-</div>
                            <div class="stat-label">Wiadomości</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="stat-value" id="online-count">-</div>
                            <div class="stat-label">Online</div>
                        </div>
                    </div>
                    
                    <!-- Informacje systemowe -->
                    <div style="margin-top: 30px;">
                        <h4><i class="fa fa-info-circle"></i> Informacje systemowe</h4>
                        <div id="system-info" style="background: #2d2d2d; padding: 15px; border-radius: 4px; margin-top: 10px;">
                            <p id="last-update">Ostatnia aktualizacja: -</p>
                            <p id="admin-user">Administrator: Ładowanie...</p>
                            <p id="template-loaded">Template: admin_panel.html</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Kontener powiadomień -->
    <div id="notifications-container"></div>

    <script>
        // Klasa AdminPanel - zoptymalizowana
        class AdminPanel {
            constructor() {
                this.isLoading = false;
                this.refreshInterval = null;
                this.init();
            }

            init() {
                console.log('Inicjalizacja panelu administratora');
                this.setupEventListeners();
                this.loadInitialData();
                this.setupAutoRefresh();
            }

            setupEventListeners() {
                const refreshBtn = document.getElementById('refresh-stats');
                const debugBtn = document.getElementById('debug-btn');
                const retryBtn = document.getElementById('retry-btn');

                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadStats());
                }

                if (debugBtn) {
                    debugBtn.addEventListener('click', () => this.runDebug());
                }

                if (retryBtn) {
                    retryBtn.addEventListener('click', () => this.loadStats());
                }
            }

            async loadInitialData() {
                try {
                    await Promise.all([
                        this.loadStats(),
                        this.loadAdminInfo()
                    ]);
                } catch (error) {
                    console.error('Błąd ładowania danych:', error);
                    this.showError('Błąd inicjalizacji panelu');
                }
            }

            async loadStats() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.showLoading();
                this.hideError();

                try {
                    const response = await fetch(`/api/admin/stats?${Date.now()}`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error(this.getErrorMessage(response.status));
                    }

                    const result = await response.json();

                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Błąd API');
                    }

                    this.updateStats(result.data);
                    this.showNotification('Statystyki zaktualizowane', 'success', 2000);

                } catch (error) {
                    console.error('Błąd ładowania statystyk:', error);
                    this.showError(`Błąd ładowania statystyk: ${error.message}`);
                    this.showNotification(`Błąd: ${error.message}`, 'error');
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }

            updateStats(stats) {
                const updates = [
                    { id: 'users-count', value: stats.users_count || 0 },
                    { id: 'sessions-count', value: stats.sessions_count || 0 },
                    { id: 'messages-count', value: stats.messages_count || 0 },
                    { id: 'online-count', value: stats.online_users_count || 0 }
                ];

                updates.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });

                document.getElementById('last-update').textContent = 
                    'Ostatnia aktualizacja: ' + new Date().toLocaleString();
            }

            async loadAdminInfo() {
                try {
                    const response = await fetch(`/api/check_admin?${Date.now()}`);
                    const data = await response.json();

                    const adminElement = document.getElementById('admin-user');
                    if (adminElement) {
                        adminElement.textContent = data.username ? 
                            `Administrator: ${data.username} (ID: ${data.user_id || 'N/A'})` :
                            'Administrator: Błąd pobierania danych';
                    }
                } catch (error) {
                    console.error('Błąd ładowania info administratora:', error);
                    const adminElement = document.getElementById('admin-user');
                    if (adminElement) {
                        adminElement.textContent = 'Administrator: Błąd pobierania danych';
                    }
                }
            }

            async runDebug() {
                console.log('Uruchamianie debugowania administratora');

                try {
                    const endpoints = [
                        '/api/admin/debug',
                        '/api/check_admin', 
                        '/check_session'
                    ];

                    const responses = await Promise.allSettled(
                        endpoints.map(url => fetch(url).then(r => r.json()))
                    );

                    console.log('Wyniki debugowania:');
                    responses.forEach((result, index) => {
                        console.log(`  ${endpoints[index]}:`, 
                            result.status === 'fulfilled' ? result.value : result.reason);
                    });

                    this.showNotification('Informacje debugowania w konsoli', 'info');
                } catch (error) {
                    console.error('Błąd debugowania:', error);
                    this.showNotification('Błąd debugowania: ' + error.message, 'error');
                }
            }

            setupAutoRefresh() {
                this.refreshInterval = setInterval(() => {
                    if (!this.isLoading) {
                        console.log('Automatyczne odświeżanie');
                        this.loadStats();
                    }
                }, 30000);
            }

            getErrorMessage(status) {
                const messages = {
                    403: 'Brak uprawnień administratora',
                    500: 'Błąd serwera - sprawdź logi',
                    404: 'Endpoint nie znaleziony'
                };
                return messages[status] || `HTTP ${status}`;
            }

            showLoading() {
                document.getElementById('loading-container').style.display = 'block';
                document.getElementById('stats-grid').classList.add('loading');
                document.getElementById('error-container').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('stats-grid').classList.remove('loading');
            }

            showError(message) {
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-container').style.display = 'block';
                document.getElementById('stats-grid').style.display = 'none';
            }

            hideError() {
                document.getElementById('error-container').style.display = 'none';
                document.getElementById('stats-grid').style.display = 'grid';
            }

            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: inherit; margin-left: 10px; cursor: pointer; font-size: 18px;">×</button>
                    </div>
                `;

                const container = document.getElementById('notifications-container');
                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }

            cleanup() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }
        }

        // Inicjalizacja
        let adminPanel;
        
        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel();
            console.log('Panel administratora gotowy');
        });

        // Obsługa błędów globalnych
        window.addEventListener('error', (e) => {
            console.error('Błąd globalny:', e.error);
            if (adminPanel) {
                adminPanel.showNotification('Wystąpił nieoczekiwany błąd', 'error');
            }
        });

        // Czyszczenie przed zamknięciem
        window.addEventListener('beforeunload', () => {
            if (adminPanel) {
                adminPanel.cleanup();
            }
        });

        console.log('Panel administratora załadowany');
    </script>
</body>
</html>