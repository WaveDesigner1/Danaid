<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_panel.css') }}">
</head>
<body class="admin-panel">
    <header class="admin-header">
        <div class="admin-logo">Admin Panel</div>
        <nav class="admin-nav">
            <a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="{{ url_for('admin.index') }}"><i class="fa fa-cogs"></i> Pełny Panel</a>
            <a href="{{ url_for('auth.logout') }}"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active"><a href="{{ url_for('admin_panel') }}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
                    <li><a href="{{ url_for('user.index_view') }}"><i class="fa fa-users"></i> Użytkownicy</a></li>
                    <li><a href="{{ url_for('chatsession.index_view') }}"><i class="fa fa-comments"></i> Sesje Czatu</a></li>
                    <li><a href="{{ url_for('message.index_view') }}"><i class="fa fa-envelope"></i> Wiadomości</a></li>
                    <li><a href="{{ url_for('db_admin.index') }}"><i class="fa fa-database"></i> Zarządzanie Bazą</a></li>
                    <li><a href="{{ url_for('diagnostics.index') }}"><i class="fa fa-stethoscope"></i> Diagnostyka</a></li>
                    <li><a href="{{ url_for('webshell.index') }}"><i class="fa fa-terminal"></i> Webshell</a></li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-stats-container">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="admin-stat-value" id="users-count">-</div>
                            <div class="admin-stat-label">Użytkownicy</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="admin-stat-value" id="sessions-count">-</div>
                            <div class="admin-stat-label">Sesje Czatu</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="admin-stat-value" id="messages-count">-</div>
                            <div class="admin-stat-label">Wiadomości</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="admin-stat-value" id="online-count">-</div>
                            <div class="admin-stat-label">Użytkownicy Online</div>
                        </div>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3><i class="fa fa-users"></i> Zarządzanie Użytkownikami</h3>
                            <button id="refresh-users" class="admin-btn secondary">
                                <i class="fa fa-refresh"></i> Odśwież
                            </button>
                        </div>
                        <div class="admin-card-body">
                            <div class="table-responsive">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nazwa</th>
                                            <th>ID Użytkownika</th>
                                            <th>Status</th>
                                            <th>Rola</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center">Ładowanie użytkowników...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Kontener powiadomień (będzie wypełniony dynamicznie) -->
    <div id="notifications-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/admin_users.js') }}"></script>
    <script>
        // Funkcja do ładowania statystyk
        function loadStats() {
            // Użytkownicy - dodajemy timestamp i nagłówki no-cache
            fetch('/api/users?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Status: ' + response.status);
                }
                return response.json();
            })
            .then(users => {
                if (Array.isArray(users)) {
                    document.getElementById('users-count').textContent = users.length;
                    const onlineCount = users.filter(user => user && user.is_online).length;
                    document.getElementById('online-count').textContent = onlineCount;
                } else if (users && users.error) {
                    console.error('API error:', users.error);
                    document.getElementById('users-count').textContent = '-';
                    document.getElementById('online-count').textContent = '-';
                }
            })
            .catch(error => {
                console.error('Błąd podczas pobierania użytkowników:', error);
                document.getElementById('users-count').textContent = '-';
                document.getElementById('online-count').textContent = '-';
            });

            // Sesje i wiadomości
            document.getElementById('sessions-count').textContent = '-';
            document.getElementById('messages-count').textContent = '-';
        }

        // Ładowanie statystyk przy załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // Odświeżanie statystyk co 30 sekund
            setInterval(loadStats, 30000);
        });
    </script>
</body>
</html>
