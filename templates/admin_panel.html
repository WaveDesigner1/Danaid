<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Danaid Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <style>
        /* ✅ DODATKOWE STYLE DLA PANELU ADMINA */
        .admin-app {
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .admin-header {
            background: #2d2d2d;
            padding: 15px 20px;
            border-bottom: 2px solid #ff9800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff9800;
        }
        
        .admin-nav a {
            color: #ffffff;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .admin-nav a:hover {
            background: #444444;
            text-decoration: none;
            color: #ff9800;
        }
        
        .admin-main {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .admin-sidebar {
            width: 250px;
            background: #2d2d2d;
            padding: 20px 0;
        }
        
        .admin-content {
            flex: 1;
            padding: 30px;
            background: #1a1a1a;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #ff9800;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 48px;
            color: #ff9800;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card {
            background: #2d2d2d;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .card-header {
            background: #444444;
            border-bottom: 1px solid #555555;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            margin: 0;
            color: #ffffff;
        }
        
        .admin-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .admin-menu li {
            margin: 5px 0;
        }
        
        .admin-menu a {
            display: block;
            padding: 12px 20px;
            color: #cccccc;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .admin-menu li.active a,
        .admin-menu a:hover {
            background: #444444;
            color: #ff9800;
            border-right: 3px solid #ff9800;
        }
        
        .error-message {
            background: #d32f2f;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }
        
        .notification-success { background: #4caf50; }
        .notification-error { background: #f44336; }
        .notification-warning { background: #ff9800; }
        .notification-info { background: #2196f3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="admin-app">
    <header class="admin-header">
        <div class="admin-logo">
            <i class="fa fa-shield"></i> Admin Panel
        </div>
        <nav class="admin-nav">
            <a href="/admin_dashboard"><i class="fa fa-dashboard"></i> Dashboard</a>
            <a href="/flask_admin/"><i class="fa fa-cogs"></i> Pełny Panel</a>
            <a href="{{ url_for('chat.chat') }}"><i class="fa fa-comments"></i> Czat</a>
            <a href="{{ url_for('auth.logout') }}"><i class="fa fa-sign-out"></i> Wyloguj</a>
        </nav>
    </header>

    <div class="admin-main">
        <aside class="admin-sidebar">
            <div class="admin-menu">
                <ul>
                    <li class="active">
                        <a href="/admin_dashboard">
                            <i class="fa fa-dashboard"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/diagnostics/">
                            <i class="fa fa-stethoscope"></i> Diagnostyka
                        </a>
                    </li>
                    <li>
                        <a href="/flask_admin/webshell/">
                            <i class="fa fa-terminal"></i> Webshell
                        </a>
                    </li>
                    <li>
                        <a href="/api/admin/debug" target="_blank">
                            <i class="fa fa-bug"></i> Debug API
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <main class="admin-content">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa fa-dashboard"></i> Dashboard Administratora</h3>
                    <div>
                        <button id="refresh-stats" class="btn btn-secondary btn-sm">
                            <i class="fa fa-refresh"></i> Odśwież
                        </button>
                        <button id="debug-btn" class="btn btn-warning btn-sm">
                            <i class="fa fa-bug"></i> Debug
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ✅ ERROR HANDLING -->
                    <div id="error-container" style="display: none;">
                        <div class="error-message">
                            <h4><i class="fa fa-exclamation-triangle"></i> Błąd</h4>
                            <p id="error-message"></p>
                            <button id="retry-btn" class="btn btn-primary btn-sm">
                                <i class="fa fa-retry"></i> Spróbuj ponownie
                            </button>
                        </div>
                    </div>
                    
                    <!-- ✅ LOADING STATE -->
                    <div id="loading-container" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #ff9800;"></i>
                        <p style="margin-top: 20px;">Ładowanie danych...</p>
                    </div>
                    
                    <!-- ✅ MAIN STATS GRID -->
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="stat-value" id="users-count">-</div>
                            <div class="stat-label">Użytkownicy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-comments"></i>
                            </div>
                            <div class="stat-value" id="sessions-count">-</div>
                            <div class="stat-label">Sesje Czatu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-envelope"></i>
                            </div>
                            <div class="stat-value" id="messages-count">-</div>
                            <div class="stat-label">Wiadomości</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fa fa-user-circle"></i>
                            </div>
                            <div class="stat-value" id="online-count">-</div>
                            <div class="stat-label">Online</div>
                        </div>
                    </div>
                    
                    <!-- ✅ SYSTEM INFO -->
                    <div style="margin-top: 30px;">
                        <h4><i class="fa fa-info-circle"></i> Informacje systemowe</h4>
                        <div id="system-info" style="background: #2d2d2d; padding: 15px; border-radius: 4px; margin-top: 10px;">
                            <p id="last-update">Ostatnia aktualizacja: -</p>
                            <p id="admin-user">Administrator: Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ✅ NOTIFICATIONS CONTAINER -->
    <div id="notifications-container"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script>
        // ✅ ENHANCED ERROR HANDLING & LOADING STATES
        let isLoading = false;
        
        function showLoading() {
            isLoading = true;
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('stats-grid').classList.add('loading');
            document.getElementById('error-container').style.display = 'none';
        }
        
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('stats-grid').classList.remove('loading');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('stats-grid').style.display = 'none';
            hideLoading();
        }
        
        function hideError() {
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('stats-grid').style.display = 'grid';
        }
        
        // ✅ ENHANCED STATS LOADING
        function loadStats() {
            if (isLoading) {
                console.log('Already loading stats, skipping...');
                return;
            }
            
            showLoading();
            hideError();
            
            console.log('🔄 Loading admin stats...');
            
            fetch('/api/admin/stats?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log(`📡 Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log("✅ Stats loaded:", result);
                
                if (result.status === 'error') {
                    throw new Error(result.message || 'Błąd API');
                }
                
                if (result.status === 'success' && result.data) {
                    const stats = result.data;
                    
                    // Update stats
                    document.getElementById('users-count').textContent = stats.users_count || 0;
                    document.getElementById('sessions-count').textContent = stats.sessions_count || 0;
                    document.getElementById('messages-count').textContent = stats.messages_count || 0;
                    document.getElementById('online-count').textContent = stats.online_users_count || 0;
                    
                    // Update system info
                    document.getElementById('last-update').textContent = 
                        'Ostatnia aktualizacja: ' + new Date().toLocaleString();
                    
                    showNotification('Statystyki zaktualizowane', 'success', 2000);
                } else {
                    throw new Error('Nieprawidłowy format danych');
                }
                
                hideLoading();
            })
            .catch(error => {
                console.error('❌ Stats loading error:', error);
                showError(`Błąd ładowania statystyk: ${error.message}`);
                showNotification(`Błąd: ${error.message}`, 'error');
            });
        }
        
        // ✅ ADMIN USER INFO
        function loadAdminInfo() {
            fetch('/api/check_admin')
            .then(response => response.json())
            .then(data => {
                if (data.username) {
                    document.getElementById('admin-user').textContent = 
                        `Administrator: ${data.username} (ID: ${data.user_id || 'N/A'})`;
                }
            })
            .catch(error => {
                console.error('❌ Admin info error:', error);
                document.getElementById('admin-user').textContent = 
                    'Administrator: Błąd pobierania danych';
            });
        }
        
        // ✅ DEBUG FUNCTION
        function runDebug() {
            console.log('🐛 Running admin debug...');
            
            Promise.all([
                fetch('/api/admin/debug').then(r => r.json()),
                fetch('/api/check_admin').then(r => r.json()),
                fetch('/check_session').then(r => r.json())
            ])
            .then(([debug, admin, session]) => {
                console.log('🔍 Debug Results:');
                console.log('  Admin Debug:', debug);
                console.log('  Admin Check:', admin);
                console.log('  Session Check:', session);
                
                showNotification('Debug info logged to console', 'info');
            })
            .catch(error => {
                console.error('❌ Debug error:', error);
                showNotification('Debug failed: ' + error.message, 'error');
            });
        }
        
        // ✅ NOTIFICATIONS
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: inherit; margin-left: 10px; cursor: pointer; font-size: 18px;">×</button>
                </div>
            `;
            
            const container = document.getElementById('notifications-container');
            container.appendChild(notification);
            
            // Auto remove
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
        
        // ✅ EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Admin panel initialized');
            
            // Load initial data
            loadStats();
            loadAdminInfo();
            
            // Button event listeners
            const refreshBtn = document.getElementById('refresh-stats');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log('🔄 Manual refresh triggered');
                    loadStats();
                });
            }
            
            const debugBtn = document.getElementById('debug-btn');
            if (debugBtn) {
                debugBtn.addEventListener('click', runDebug);
            }
            
            const retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    console.log('🔄 Retry triggered');
                    loadStats();
                });
            }
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (!isLoading) {
                    console.log('⏰ Auto-refresh triggered');
                    loadStats();
                }
            }, 30000);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    loadStats();
                }
                if (e.key === 'F5') {
                    e.preventDefault();
                    loadStats();
                }
            });
            
            console.log('✅ Admin panel ready');
        });
        
        // ✅ GLOBAL ERROR HANDLER
        window.addEventListener('error', function(e) {
            console.error('💥 Global error:', e.error);
            showNotification('Wystąpił nieoczekiwany błąd', 'error');
        });
        
        // ✅ GLOBAL FUNCTIONS (for console debugging)
        window.adminDebug = {
            loadStats: loadStats,
            loadAdminInfo: loadAdminInfo, 
            runDebug: runDebug,
            showNotification: showNotification
        };
        
        console.log('✅ Admin panel JavaScript loaded');
        console.log('🔧 Available debug functions: window.adminDebug');
    </script>
</body>
</html>
