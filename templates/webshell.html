{% extends 'admin/base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Webshell</h2>
            
            <div class="alert alert-warning">
                <h4>Uwaga!</h4>
                <p>Ten moduł pozwala na wykonywanie podstawowych komend systemowych. Używaj z rozwagą!</p>
                <p><strong>Dozwolone komendy:</strong> ls, ps, df, free, uptime, cat, grep, head, tail, find</p>
            </div>
            
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Konsola</h3>
                </div>
                <div class="panel-body">
                    <form method="post" action="{{ url_for('webshell.index') }}" id="webshell-form">
                        <div class="input-group">
                            <span class="input-group-addon">$</span>
                            <input type="text" name="command" id="command-input" class="form-control" placeholder="Wprowadź komendę" value="{{ command if command else '' }}">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" type="submit">Wykonaj</button>
                            </span>
                        </div>
                    </form>
                    
                    {% if result %}
                    <div class="well" id="result-container" style="margin-top: 20px; background-color: #000; color: #ccc; font-family: monospace; white-space: pre-wrap;">{{ result }}</div>
                    {% else %}
                    <div class="well" id="result-container" style="margin-top: 20px; background-color: #000; color: #ccc; font-family: monospace; white-space: pre-wrap; display: none;"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const commandInput = document.getElementById('command-input');
        const webshellForm = document.getElementById('webshell-form');
        const resultContainer = document.getElementById('result-container');
        
        // Automatycznie ustaw focus na polu wejściowym
        commandInput.focus();
        
        // Historia komend
        let commandHistory = [];
        let historyIndex = -1;
        
        // Obsługa klawisza Enter i strzałek
        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateHistory(-1); // w górę historii
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateHistory(1);  // w dół historii
            }
        });
        
        // Obsługa formularza z AJAX
        webshellForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const command = commandInput.value.trim();
            if (!command) return;
            
            // Dodaj komendę do historii
            commandHistory.unshift(command);
            historyIndex = -1;
            
            // Ogranicz historię do 20 komend
            if (commandHistory.length > 20) {
                commandHistory.pop();
            }
            
            // Wyślij zapytanie AJAX
            fetch('{{ url_for("webshell.index") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'command=' + encodeURIComponent(command)
            })
            .then(response => response.json())
            .then(data => {
                // Pokaż kontener wyniku
                resultContainer.style.display = 'block';
                
                // Ustaw wynik
                resultContainer.textContent = '$ ' + command + '\n\n' + (data.result || 'Brak wyników');
                
                // Wyczyść pole wejściowe i ustaw focus
                commandInput.value = '';
                commandInput.focus();
            })
            .catch(error => {
                console.error('Błąd:', error);
                resultContainer.style.display = 'block';
                resultContainer.textContent = '$ ' + command + '\n\nBłąd: ' + error.message;
                
                // Wyczyść pole wejściowe i ustaw focus
                commandInput.value = '';
                commandInput.focus();
            });
        });
        
        // Funkcja do nawigacji po historii komend
        function navigateHistory(direction) {
            // direction: -1 = góra (starsze), 1 = dół (nowsze)
            if (commandHistory.length === 0) return;
            
            // Zaktualizuj indeks
            historyIndex = Math.max(-1, Math.min(commandHistory.length - 1, historyIndex + direction));
            
            // Ustaw komendę z historii lub wyczyść
            if (historyIndex === -1) {
                commandInput.value = '';
            } else {
                commandInput.value = commandHistory[historyIndex];
            }
            
            // Ustaw kursor na końcu tekstu
            setTimeout(() => {
                commandInput.selectionStart = commandInput.selectionEnd = commandInput.value.length;
            }, 0);
        }
    });
</script>
{% endblock %}
